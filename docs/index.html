<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sistema de Gestión de Inventario - Versión Corregida</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style id="app-style">
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .loading {
      position: relative;
      pointer-events: none;
    }
    .loading:after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      opacity: 0;
      transform: translateY(-20px);
      max-width: 400px;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .toast-success {
      background-color: #10b981;
      color: white;
    }
    .toast-error {
      background-color: #ef4444;
      color: white;
    }
    .toast-warning {
      background-color: #f59e0b;
      color: white;
    }
    .toast-info {
      background-color: #3b82f6;
      color: white;
    }
    .table-container {
      overflow-x: auto;
    }
    .image-preview {
      max-width: 100px;
      max-height: 100px;
      object-fit: contain;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .image-preview:hover {
      transform: scale(1.05);
    }
    .thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .thumbnail:hover {
      transform: scale(1.1);
    }
    .image-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      cursor: pointer;
    }
    .image-modal img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 8px;
    }
    .connection-indicator {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.875rem;
    }
    .connection-success {
      background-color: #dcfce7;
      color: #166534;
    }
    .connection-error {
      background-color: #fef2f2;
      color: #dc2626;
    }
    .connection-loading {
      background-color: #fef3c7;
      color: #d97706;
    }
    .form-error {
      border-color: #ef4444 !important;
      background-color: #fef2f2;
    }
    .error-message {
      color: #ef4444;
      font-size: 0.875rem;
      margin-top: 4px;
    }
    .image-upload-area {
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      transition: border-color 0.2s;
      cursor: pointer;
    }
    .image-upload-area:hover {
      border-color: #3b82f6;
    }
    .image-upload-area.dragover {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }
    @media (max-width: 640px) {
      .responsive-table {
        display: block;
        width: 100%;
        overflow-x: auto;
      }
      .toast {
        right: 10px;
        left: 10px;
        max-width: none;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-6">
    <header class="mb-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-800 mb-2">Sistema de Gestión de Inventario</h1>
          <p class="text-gray-600">Control completo de accesorios y entregas</p>
        </div>
        <div class="mt-4 md:mt-0">
          <div id="connection-status" class="connection-indicator connection-loading">
            <i class="fas fa-spinner fa-spin mr-2"></i>
            <span>Conectando a Supabase...</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Tabs Navigation -->
    <div class="border-b border-gray-200 mb-6">
      <ul class="flex flex-wrap -mb-px" id="tabs">
        <li class="mr-2">
          <a href="javascript:void(0)" class="tab-link inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 active" data-tab="entrada">
            <i class="fas fa-box-open mr-2"></i>Entrada de Inventario
          </a>
        </li>
        <li class="mr-2">
          <a href="javascript:void(0)" class="tab-link inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" data-tab="stock">
            <i class="fas fa-warehouse mr-2"></i>Stock
          </a>
        </li>
        <li>
          <a href="javascript:void(0)" class="tab-link inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" data-tab="entrega">
            <i class="fas fa-handshake mr-2"></i>Entregas
          </a>
        </li>
      </ul>
    </div>

    <!-- Tab Content -->
    <div id="tab-contents">
      <!-- Entrada de Inventario -->
      <div id="entrada-tab" class="tab-content active">
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold">Registro de Entrada de Inventario</h2>
            <button id="limpiar-formulario-entrada" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">
              <i class="fas fa-broom mr-2"></i>Limpiar
            </button>
          </div>
          
          <form id="entrada-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <input type="hidden" id="entrada-id">
            
            <div class="form-group">
              <label for="numero-parte" class="block text-sm font-medium text-gray-700 mb-1">
                Número de Parte *
              </label>
              <input type="text" id="numero-parte" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="Ej: ACC-001">
              <div id="numero-parte-error" class="error-message hidden"></div>
            </div>
            
            <div class="form-group">
              <label for="fecha-entrada" class="block text-sm font-medium text-gray-700 mb-1">
                Fecha de Entrada *
              </label>
              <input type="datetime-local" id="fecha-entrada" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              <div id="fecha-entrada-error" class="error-message hidden"></div>
            </div>
            
            <div class="form-group md:col-span-2">
              <label for="descripcion" class="block text-sm font-medium text-gray-700 mb-1">
                Descripción del accesorio *
              </label>
              <textarea id="descripcion" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" required placeholder="Descripción detallada del accesorio"></textarea>
              <div id="descripcion-error" class="error-message hidden"></div>
            </div>
            
            <div class="form-group">
              <label for="ubicacion" class="block text-sm font-medium text-gray-700 mb-1">
                Ubicación *
              </label>
              <input type="text" id="ubicacion" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="Ej: Jaula A-1">
              <div id="ubicacion-error" class="error-message hidden"></div>
            </div>
            
            <div class="form-group">
              <label for="cantidad" class="block text-sm font-medium text-gray-700 mb-1">
                Cantidad ingresada *
              </label>
              <input type="number" id="cantidad" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              <div id="cantidad-error" class="error-message hidden"></div>
            </div>
            
            <div class="form-group md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Imágenes del accesorio
              </label>
              <div class="image-upload-area" id="image-upload-area">
                <input type="file" id="imagenes" multiple accept="image/*" class="hidden">
                <div class="upload-content">
                  <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                  <p class="text-gray-600">Haz clic aquí o arrastra imágenes</p>
                  <p class="text-sm text-gray-400">PNG, JPG, GIF hasta 5MB cada una</p>
                </div>
              </div>
              <div id="image-preview-container" class="mt-3 flex flex-wrap gap-2"></div>
              <div id="existing-images-container" class="mt-3 flex flex-wrap gap-2"></div>
              <div id="imagenes-error" class="error-message hidden"></div>
            </div>
            
            <div class="md:col-span-2 mt-4 flex gap-3">
              <button type="submit" id="guardar-entrada" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                <i class="fas fa-save mr-2"></i>
                <span id="btn-text">Guardar Entrada</span>
              </button>
              <button type="button" id="cancelar-entrada" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors hidden">
                <i class="fas fa-times mr-2"></i>Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Stock -->
      <div id="stock-tab" class="tab-content">
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold">Gestión de Stock</h2>
            <button id="actualizar-stock" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
              <i class="fas fa-sync-alt mr-2"></i>Actualizar
            </button>
          </div>
          
          <!-- Filtros -->
          <div class="mb-6 bg-gray-50 p-4 rounded-md">
            <h3 class="text-sm font-medium text-gray-700 mb-3">Filtros de búsqueda</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="form-group">
                <label for="filtro-parte" class="block text-sm font-medium text-gray-700 mb-1">Número de Parte</label>
                <input type="text" id="filtro-parte" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Buscar...">
              </div>
              
              <div class="form-group">
                <label for="filtro-descripcion" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                <input type="text" id="filtro-descripcion" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Buscar...">
              </div>
              
              <div class="form-group">
                <label for="filtro-ubicacion" class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                <input type="text" id="filtro-ubicacion" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Buscar...">
              </div>
              
              <div class="form-group flex items-end">
                <button id="aplicar-filtros" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors mr-2">
                  <i class="fas fa-filter mr-1"></i>Filtrar
                </button>
                <button id="limpiar-filtros" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors">
                  <i class="fas fa-broom mr-1"></i>Limpiar
                </button>
              </div>
            </div>
          </div>
          
          <!-- Botones de exportación -->
          <div class="flex justify-end mb-4 gap-2">
            <button id="exportar-excel" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
              <i class="fas fa-file-excel mr-1"></i>Excel
            </button>
            <button id="exportar-pdf" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
              <i class="fas fa-file-pdf mr-1"></i>PDF
            </button>
          </div>
          
          <!-- Tabla de stock -->
          <div class="table-container responsive-table">
            <table id="stock-table" class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
              <thead class="bg-gray-100">
                <tr>
                  <th class="py-3 px-4 border-b text-left font-medium text-gray-700">Número de Parte</th>
                  <th class="py-3 px-4 border-b text-left font-medium text-gray-700">Descripción</th>
                  <th class="py-3 px-4 border-b text-left font-medium text-gray-700">Ubicación</th>
                  <th class="py-3 px-4 border-b text-right font-medium text-gray-700">Cantidad</th>
                  <th class="py-3 px-4 border-b text-center font-medium text-gray-700">Imagen</th>
                  <th class="py-3 px-4 border-b text-center font-medium text-gray-700">Acciones</th>
                </tr>
              </thead>
              <tbody id="stock-items">
                <tr>
                  <td colspan="6" class="py-8 px-4 text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin mr-2"></i>Cargando inventario...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Paginación -->
          <div class="mt-6 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="text-sm text-gray-500">
              Mostrando <span id="items-showing">0</span> de <span id="items-total">0</span> elementos
            </div>
            <div class="flex space-x-2">
              <button id="prev-page" class="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-chevron-left"></i>
              </button>
              <span id="page-info" class="px-4 py-2 text-sm">
                Página <span id="current-page">1</span> de <span id="total-pages">1</span>
              </span>
              <button id="next-page" class="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Entregas -->
      <div id="entrega-tab" class="tab-content">
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold">Registro de Entregas</h2>
            <button id="limpiar-formulario-entrega" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">
              <i class="fas fa-broom mr-2"></i>Limpiar
            </button>
          </div>
          
          <form id="entrega-form" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <input type="hidden" id="entrega-id">
            
            <div class="form-group">
              <label for="accesorio-id" class="block text-sm font-medium text-gray-700 mb-1">
                Accesorio *
              </label>
              <select id="accesorio-id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <option value="">Seleccione un accesorio</option>
              </select>
              <div id="accesorio-id-error" class="error-message hidden"></div>
            </div>
            
            <div class="form-group">
              <label for="tipo-accesorio" class="block text-sm font-medium text-gray-700 mb-1">
                Tipo de Accesorio *
              </label>
              <select id="tipo-accesorio" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <option value="">Seleccione un tipo</option>
                <option value="bolsa">Bolsa</option>
                <option value="gorra">Gorra</option>
                <option value="guantes">Guantes</option>
                <option value="pelota">Pelota</option>
                <option value="accesorio-pequeno">Accesorio pequeño</option>
                <option value="kit">Kit</option>
              </select>
              <div id="tipo-accesorio-error" class="error-message hidden"></div>
            </div>
            
            <div class="form-group">
              <label for="cantidad-salida" class="block text-sm font-medium text-gray-700 mb-1">
                Cantidad *
              </label>
              <input type="number" id="cantidad-salida" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              <div id="stock-disponible" class="text-sm text-gray-500 mt-1"></div>
              <div id="cantidad-salida-error" class="error-message hidden"></div>
            </div>
            
            <div class="form-group">
              <label for="supervisor" class="block text-sm font-medium text-gray-700 mb-1">
                Supervisor *
              </label>
              <select id="supervisor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <option value="">Seleccione un supervisor</option>
                <option value="Juan Pérez">Juan Pérez</option>
                <option value="María García">María García</option>
                <option value="Carlos López">Carlos López</option>
                <option value="Ana Rodríguez">Ana Rodríguez</option>
              </select>
              <div id="supervisor-error" class="error-message hidden"></div>
            </div>
            
            <div class="form-group">
              <label for="persona-entrega" class="block text-sm font-medium text-gray-700 mb-1">
                Persona que entrega *
              </label>
              <select id="persona-entrega" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <option value="">Seleccione una persona</option>
                <option value="Yodeli">Yodeli</option>
                <option value="Denise">Denise</option>
              </select>
              <div id="persona-entrega-error" class="error-message hidden"></div>
            </div>
            
            <div class="form-group">
              <label for="fecha-salida" class="block text-sm font-medium text-gray-700 mb-1">
                Fecha de Salida *
              </label>
              <input type="datetime-local" id="fecha-salida" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              <div id="fecha-salida-error" class="error-message hidden"></div>
            </div>
            
            <div class="md:col-span-3 flex gap-3">
              <button type="submit" id="registrar-salida" class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
                <i class="fas fa-paper-plane mr-2"></i>
                <span id="btn-entrega-text">Registrar Entrega</span>
              </button>
              <button type="button" id="cancelar-entrega" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors hidden">
                <i class="fas fa-times mr-2"></i>Cancelar
              </button>
            </div>
          </form>
          
          <hr class="my-8">
          
          <h3 class="text-lg font-semibold mb-4">Historial de Entregas</h3>
          
          <!-- Filtros de entregas -->
          <div class="mb-6 bg-gray-50 p-4 rounded-md">
            <h4 class="text-sm font-medium text-gray-700 mb-3">Filtros de búsqueda</h4>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="form-group">
                <label for="filtro-fecha" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                <input type="date" id="filtro-fecha" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              
              <div class="form-group">
                <label for="filtro-supervisor" class="block text-sm font-medium text-gray-700 mb-1">Supervisor</label>
                <select id="filtro-supervisor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Todos</option>
                  <option value="Juan Pérez">Juan Pérez</option>
                  <option value="María García">María García</option>
                  <option value="Carlos López">Carlos López</option>
                  <option value="Ana Rodríguez">Ana Rodríguez</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="filtro-tipo" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                <select id="filtro-tipo" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Todos</option>
                  <option value="bolsa">Bolsa</option>
                  <option value="gorra">Gorra</option>
                  <option value="guantes">Guantes</option>
                  <option value="pelota">Pelota</option>
                  <option value="accesorio-pequeno">Accesorio pequeño</option>
                  <option value="kit">Kit</option>
                </select>
              </div>
              
              <div class="form-group flex items-end">
                <button id="aplicar-filtros-entregas" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors mr-2">
                  <i class="fas fa-filter mr-1"></i>Filtrar
                </button>
                <button id="limpiar-filtros-entregas" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors">
                  <i class="fas fa-broom mr-1"></i>Limpiar
                </button>
              </div>
            </div>
          </div>
          
          <!-- Botones de exportación -->
          <div class="flex justify-end mb-4 gap-2">
            <button id="exportar-excel-entregas" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
              <i class="fas fa-file-excel mr-1"></i>Excel
            </button>
            <button id="exportar-pdf-entregas" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
              <i class="fas fa-file-pdf mr-1"></i>PDF
            </button>
          </div>
          
          <!-- Tabla de entregas -->
          <div class="table-container responsive-table">
            <table id="entregas-table" class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
              <thead class="bg-gray-100">
                <tr>
                  <th class="py-3 px-4 border-b text-left font-medium text-gray-700">ID</th>
                  <th class="py-3 px-4 border-b text-left font-medium text-gray-700">Accesorio</th>
                  <th class="py-3 px-4 border-b text-left font-medium text-gray-700">Tipo</th>
                  <th class="py-3 px-4 border-b text-right font-medium text-gray-700">Cantidad</th>
                  <th class="py-3 px-4 border-b text-left font-medium text-gray-700">Fecha</th>
                  <th class="py-3 px-4 border-b text-left font-medium text-gray-700">Supervisor</th>
                  <th class="py-3 px-4 border-b text-left font-medium text-gray-700">Persona</th>
                  <th class="py-3 px-4 border-b text-center font-medium text-gray-700">Acciones</th>
                </tr>
              </thead>
              <tbody id="entregas-items">
                <tr>
                  <td colspan="8" class="py-8 px-4 text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin mr-2"></i>Cargando entregas...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Paginación entregas -->
          <div class="mt-6 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="text-sm text-gray-500">
              Mostrando <span id="entregas-showing">0</span> de <span id="entregas-total">0</span> elementos
            </div>
            <div class="flex space-x-2">
              <button id="prev-page-entregas" class="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-chevron-left"></i>
              </button>
              <span id="page-info-entregas" class="px-4 py-2 text-sm">
                Página <span id="current-page-entregas">1</span> de <span id="total-pages-entregas">1</span>
              </span>
              <button id="next-page-entregas" class="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para ver imagen completa -->
  <div id="image-modal" class="image-modal hidden" onclick="closeImageModal()">
    <img id="modal-image" src="" alt="Imagen completa">
  </div>

  <!-- Configuración y Scripts -->
  <script>
    // ===== CONFIGURACIÓN =====
    const CONFIG = {
      supabase: {
        url: 'https://lwdapqzcrezgfkhgftac.supabase.co',
        anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3ZGFwcXpjcmV6Z2ZraGdmdGFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTg0MzYsImV4cCI6MjA2NzQ5NDQzNn0.7X8mYgIVUTvaQXS5UE2gdlogolPQQmcOqzgaVemCI7k',
        storage: {
          bucketName: 'imagenes',
          folder: 'accesorios'
        }
      },
      app: {
        itemsPerPage: 10,
        maxImageSize: 5 * 1024 * 1024, // 5MB
        allowedImageTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp']
      }
    };

    // ===== VARIABLES GLOBALES =====
    let supabase;
    let isConnected = false;
    let currentStock = [];
    let currentEntregas = [];
    let currentPage = 1;
    let currentPageEntregas = 1;

    // Datos mock para modo demo
    const mockData = {
      entrada: [
        {
          id: 1,
          "Número de Parte": "ACC-001",
          "Descripción del accesorio": "Bolsa deportiva grande",
          "Ubicación": "Jaula A-1",
          "Cantidad ingresada": 25,
          "Imágenes": false,
          "Fecha de Entrada": "2024-01-15T10:30:00"
        },
        {
          id: 2,
          "Número de Parte": "ACC-002",
          "Descripción del accesorio": "Gorra ajustable",
          "Ubicación": "Jaula B-3",
          "Cantidad ingresada": 50,
          "Imágenes": false,
          "Fecha de Entrada": "2024-01-16T14:20:00"
        }
      ],
      entrega: [
        {
          id: 1,
          "ID de Accesorio": "ACC-001",
          "Cantidad": 5,
          "Tipo de Accesorio": "bolsa",
          "Fecha de Salida": "2024-01-20T09:15:00",
          "Supervisor": "Juan Pérez",
          "Persona que entrega": "Yodeli"
        }
      ]
    };

    // ===== FUNCIONES DE UTILIDAD PARA MANEJO SEGURO DEL DOM =====
    function safeGetElement(id) {
      const element = document.getElementById(id);
      if (!element) {
        console.warn(`Elemento con ID '${id}' no encontrado`);
      }
      return element;
    }

    function safeSetTextContent(id, text) {
      const element = safeGetElement(id);
      if (element) {
        element.textContent = text;
      }
    }

    function safeSetValue(id, value) {
      const element = safeGetElement(id);
      if (element) {
        element.value = value;
      }
    }

    function safeSetInnerHTML(id, html) {
      const element = safeGetElement(id);
      if (element) {
        element.innerHTML = html;
      }
    }

    function safeAddClass(id, className) {
      const element = safeGetElement(id);
      if (element) {
        element.classList.add(className);
      }
    }

    function safeRemoveClass(id, className) {
      const element = safeGetElement(id);
      if (element) {
        element.classList.remove(className);
      }
    }

    // ===== INICIALIZACIÓN =====
    document.addEventListener('DOMContentLoaded', function() {
      initSupabase();
      setupEventListeners();
      setupImageUpload();
      setCurrentDateTime();
      loadInitialData();
    });

    function initSupabase() {
      try {
        if (CONFIG.supabase.url === 'TU_SUPABASE_URL_AQUI' || CONFIG.supabase.anonKey === 'TU_SUPABASE_ANON_KEY_AQUI') {
          throw new Error('Credenciales no configuradas');
        }
        
        supabase = window.supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.anonKey);
        isConnected = true;
        updateConnectionStatus('success', 'Conectado a Supabase');
      } catch (error) {
        console.warn('Modo demo activo:', error.message);
        isConnected = false;
        updateConnectionStatus('error', 'Modo demo - Configura Supabase para usar la base de datos');
      }
    }

    function updateConnectionStatus(type, message) {
      const statusElement = safeGetElement('connection-status');
      if (statusElement) {
        statusElement.className = `connection-indicator connection-${type}`;
        
        const icon = type === 'success' ? 'fa-check-circle' : 
                     type === 'error' ? 'fa-exclamation-triangle' : 
                     'fa-spinner fa-spin';
        
        statusElement.innerHTML = `<i class="fas ${icon} mr-2"></i><span>${message}</span>`;
      }
    }

    function setCurrentDateTime() {
      const now = new Date();
      const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
      safeSetValue('fecha-entrada', localDateTime);
      safeSetValue('fecha-salida', localDateTime);
    }

    // ===== MANEJO DE EVENTOS =====
    function setupEventListeners() {
      // Pestañas
      document.querySelectorAll('.tab-link').forEach(link => {
        link.addEventListener('click', handleTabClick);
      });

      // Formularios
      const entradaForm = safeGetElement('entrada-form');
      const entregaForm = safeGetElement('entrega-form');
      
      if (entradaForm) entradaForm.addEventListener('submit', handleEntradaSubmit);
      if (entregaForm) entregaForm.addEventListener('submit', handleEntregaSubmit);

      // Botones de limpiar
      const limpiarEntrada = safeGetElement('limpiar-formulario-entrada');
      const limpiarEntrega = safeGetElement('limpiar-formulario-entrega');
      
      if (limpiarEntrada) limpiarEntrada.addEventListener('click', clearEntradaForm);
      if (limpiarEntrega) limpiarEntrega.addEventListener('click', clearEntregaForm);

      // Botones de cancelar
      const cancelarEntrada = safeGetElement('cancelar-entrada');
      const cancelarEntrega = safeGetElement('cancelar-entrega');
      
      if (cancelarEntrada) cancelarEntrada.addEventListener('click', cancelEntradaEdit);
      if (cancelarEntrega) cancelarEntrega.addEventListener('click', cancelEntregaEdit);

      // Filtros
      const aplicarFiltros = safeGetElement('aplicar-filtros');
      const limpiarFiltros = safeGetElement('limpiar-filtros');
      const aplicarFiltrosEntregas = safeGetElement('aplicar-filtros-entregas');
      const limpiarFiltrosEntregas = safeGetElement('limpiar-filtros-entregas');
      
      if (aplicarFiltros) aplicarFiltros.addEventListener('click', applyStockFilters);
      if (limpiarFiltros) limpiarFiltros.addEventListener('click', clearStockFilters);
      if (aplicarFiltrosEntregas) aplicarFiltrosEntregas.addEventListener('click', applyEntregasFilters);
      if (limpiarFiltrosEntregas) limpiarFiltrosEntregas.addEventListener('click', clearEntregasFilters);

      // Exportación
      const exportarExcel = safeGetElement('exportar-excel');
      const exportarPdf = safeGetElement('exportar-pdf');
      const exportarExcelEntregas = safeGetElement('exportar-excel-entregas');
      const exportarPdfEntregas = safeGetElement('exportar-pdf-entregas');
      
      if (exportarExcel) exportarExcel.addEventListener('click', () => exportStock('excel'));
      if (exportarPdf) exportarPdf.addEventListener('click', () => exportStock('pdf'));
      if (exportarExcelEntregas) exportarExcelEntregas.addEventListener('click', () => exportEntregas('excel'));
      if (exportarPdfEntregas) exportarPdfEntregas.addEventListener('click', () => exportEntregas('pdf'));

      // Actualizar
      const actualizarStock = safeGetElement('actualizar-stock');
      if (actualizarStock) actualizarStock.addEventListener('click', loadStock);

      // Selector de accesorio en entregas
      const accesorioId = safeGetElement('accesorio-id');
      if (accesorioId) accesorioId.addEventListener('change', updateStockInfo);
    }

    function handleTabClick(e) {
      e.preventDefault();
      const tabId = this.getAttribute('data-tab');
      
      // Actualizar clases activas
      document.querySelectorAll('.tab-link').forEach(el => {
        el.classList.remove('active', 'text-blue-600', 'border-blue-600');
      });
      document.querySelectorAll('.tab-content').forEach(el => {
        el.classList.remove('active');
      });
      
      this.classList.add('active', 'text-blue-600', 'border-blue-600');
      const tabContent = safeGetElement(`${tabId}-tab`);
      if (tabContent) tabContent.classList.add('active');
      
      // Cargar datos según la pestaña
      if (tabId === 'stock') {
        loadStock();
      } else if (tabId === 'entrega') {
        loadAccesoriosDropdown();
        loadEntregas();
      }
    }

    // ===== MANEJO DE IMÁGENES =====
    function setupImageUpload() {
      const uploadArea = safeGetElement('image-upload-area');
      const fileInput = safeGetElement('imagenes');
      
      if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
      }
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('dragover');
    }

    function handleDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      const fileInput = safeGetElement('imagenes');
      if (fileInput) {
        fileInput.files = files;
        handleFileSelect({ target: { files } });
      }
    }

    function handleFileSelect(e) {
      const files = e.target.files;
      const previewContainer = safeGetElement('image-preview-container');
      
      if (!previewContainer) return;
      
      previewContainer.innerHTML = '';
      
      if (files.length === 0) return;
      
      // Validar archivos
      const validation = validateImages(files);
      if (!validation.isValid) {
        showToast(validation.errors.join(', '), 'error');
        return;
      }
      
      // Mostrar vista previa
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const div = document.createElement('div');
          div.className = 'relative';
          div.innerHTML = `
            <img src="${e.target.result}" class="image-preview" onclick="showImageModal('${e.target.result}')">
            <button type="button" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600" onclick="removeImagePreview(this)">
              <i class="fas fa-times"></i>
            </button>
          `;
          previewContainer.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
    }

    function validateImages(files) {
      const errors = [];
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        if (!CONFIG.app.allowedImageTypes.includes(file.type)) {
          errors.push(`${file.name}: Tipo no válido`);
        }
        
        if (file.size > CONFIG.app.maxImageSize) {
          errors.push(`${file.name}: Muy grande (máx. 5MB)`);
        }
      }
      
      return {
        isValid: errors.length === 0,
        errors: errors
      };
    }

    function removeImagePreview(button) {
      button.parentElement.remove();
      // Limpiar el input de archivos
      safeSetValue('imagenes', '');
    }

    function showImageModal(src) {
      const modal = safeGetElement('image-modal');
      const modalImage = safeGetElement('modal-image');
      if (modal && modalImage) {
        modalImage.src = src;
        modal.classList.remove('hidden');
      }
    }

    function closeImageModal() {
      const modal = safeGetElement('image-modal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // ===== FUNCIONES DE BASE DE DATOS =====
    async function executeQuery(operation, table, data = null, filters = null) {
      if (!isConnected) {
        return executeMockQuery(operation, table, data, filters);
      }

      try {
        let query = supabase.from(table);
        
        switch (operation) {
          case 'select':
            if (filters) {
              Object.keys(filters).forEach(key => {
                if (filters[key]) {
                  query = query.ilike(key, `%${filters[key]}%`);
                }
              });
            }
            return await query.select('*').order('id', { ascending: false });
            
          case 'insert':
            return await query.insert(data).select();
            
          case 'update':
            return await query.update(data).eq('id', data.id).select();
            
          case 'delete':
            return await query.delete().eq('id', data.id);
            
          default:
            throw new Error(`Operación no soportada: ${operation}`);
        }
      } catch (error) {
        console.error(`Error en ${operation} ${table}:`, error);
        throw error;
      }
    }

    function executeMockQuery(operation, table, data = null, filters = null) {
      return new Promise((resolve) => {
        setTimeout(() => {
          let result = { data: null, error: null };
          
          switch (operation) {
            case 'select':
              result.data = mockData[table] || [];
              if (filters) {
                result.data = result.data.filter(item => {
                  return Object.keys(filters).every(key => {
                    if (!filters[key]) return true;
                    const itemValue = item[key] || '';
                    return itemValue.toString().toLowerCase().includes(filters[key].toLowerCase());
                  });
                });
              }
              break;
              
            case 'insert':
              const newId = Math.max(...(mockData[table]?.map(item => item.id) || [0])) + 1;
              const newItem = { id: newId, ...data };
              if (!mockData[table]) mockData[table] = [];
              mockData[table].push(newItem);
              result.data = [newItem];
              break;
              
            case 'update':
              if (mockData[table]) {
                const index = mockData[table].findIndex(item => item.id === data.id);
                if (index !== -1) {
                  mockData[table][index] = { ...mockData[table][index], ...data };
                  result.data = [mockData[table][index]];
                }
              }
              break;
              
            case 'delete':
              if (mockData[table]) {
                const index = mockData[table].findIndex(item => item.id === data.id);
                if (index !== -1) {
                  mockData[table].splice(index, 1);
                  result.data = [];
                }
              }
              break;
          }
          
          resolve(result);
        }, 300);
      });
    }

    // ===== FUNCIONES DE ENTRADA =====
    async function handleEntradaSubmit(e) {
      e.preventDefault();
      
      const isEditing = safeGetElement('entrada-id')?.value;
      const button = safeGetElement('guardar-entrada');
      const originalText = button?.innerHTML;
      
      try {
        if (button) {
          button.disabled = true;
          button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
        }
        
        // Recopilar datos
        const formData = {
          "Número de Parte": safeGetElement('numero-parte')?.value?.trim()?.toUpperCase() || '',
          "Descripción del accesorio": safeGetElement('descripcion')?.value?.trim() || '',
          "Ubicación": safeGetElement('ubicacion')?.value?.trim() || '',
          "Cantidad ingresada": parseInt(safeGetElement('cantidad')?.value || 0),
          "Imágenes": (safeGetElement('imagenes')?.files?.length || 0) > 0,
          "Fecha de Entrada": safeGetElement('fecha-entrada')?.value || ''
        };
        
        if (isEditing) {
          formData.id = parseInt(isEditing);
        }
        
        // Subir imágenes si hay
        const imageFiles = safeGetElement('imagenes')?.files;
        if (imageFiles && imageFiles.length > 0) {
          const file = imageFiles[0];
          const uploadResult = await uploadImage(file);
          
          if (uploadResult.error) {
            throw new Error('Error al subir imagen');
          }
          
          formData["Ruta de Imagen"] = uploadResult.data.path;
        }
        
        // Guardar en base de datos
        const result = isEditing ? 
          await executeQuery('update', 'entrada', formData) :
          await executeQuery('insert', 'entrada', formData);
        
        if (result.error) {
          throw new Error(result.error.message);
        }
        
        showToast(isEditing ? 'Entrada actualizada correctamente' : 'Entrada registrada correctamente', 'success');
        clearEntradaForm();
        loadStock(); // Actualizar stock
        
      } catch (error) {
        console.error('Error al guardar entrada:', error);
        showToast('Error al guardar entrada: ' + error.message, 'error');
      } finally {
        if (button) {
          button.disabled = false;
          button.innerHTML = originalText || '<i class="fas fa-save mr-2"></i><span>Guardar Entrada</span>';
        }
      }
    }

    // ===== FUNCIÓN CORREGIDA clearEntradaForm =====
    function clearEntradaForm() {
      try {
        // Resetear formulario de manera segura
        const form = safeGetElement('entrada-form');
        if (form) {
          form.reset();
        }
        
        // Limpiar campos específicos de manera segura
        safeSetValue('entrada-id', '');
        
        // Limpiar contenedores de imágenes
        safeSetInnerHTML('image-preview-container', '');
        safeSetInnerHTML('existing-images-container', '');
        
        // Resetear texto del botón de manera segura
        safeSetInnerHTML('btn-text', 'Guardar Entrada');
        
        // Ocultar botón de cancelar
        safeAddClass('cancelar-entrada', 'hidden');
        
        // Establecer fecha actual
        setCurrentDateTime();
        
        // Limpiar errores del formulario
        clearFormErrors();
        
        console.log('Formulario de entrada limpiado correctamente');
      } catch (error) {
        console.error('Error al limpiar formulario de entrada:', error);
        // Mostrar toast de error pero no interrumpir el flujo
        showToast('Formulario limpiado (con advertencias menores)', 'warning');
      }
    }

    function cancelEntradaEdit() {
      clearEntradaForm();
    }

    // ===== FUNCIONES DE STOCK =====
    async function loadStock() {
      try {
        safeSetInnerHTML('stock-items', '<tr><td colspan="6" class="py-8 px-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Cargando inventario...</td></tr>');
        
        const { data, error } = await executeQuery('select', 'entrada');
        
        if (error) {
          throw new Error(error.message);
        }
        
        // Calcular stock consolidado
        currentStock = calculateStock(data);
        displayStock(currentStock);
        
      } catch (error) {
        console.error('Error al cargar stock:', error);
        showToast('Error al cargar inventario', 'error');
      }
    }

    function calculateStock(entradas) {
      const stockMap = {};
      
      entradas.forEach(entrada => {
        const numeroParte = entrada["Número de Parte"];
        if (!stockMap[numeroParte]) {
          stockMap[numeroParte] = {
            "Número de Parte": numeroParte,
            "Descripción del accesorio": entrada["Descripción del accesorio"],
            "Ubicación": entrada["Ubicación"],
            "Cantidad Disponible": 0,
            "Imágenes": entrada["Imágenes"],
            "Ruta de Imagen": entrada["Ruta de Imagen"],
            "Última Entrada": entrada["Fecha de Entrada"]
          };
        }
        stockMap[numeroParte]["Cantidad Disponible"] += entrada["Cantidad ingresada"];
        
        // Mantener la fecha más reciente
        if (new Date(entrada["Fecha de Entrada"]) > new Date(stockMap[numeroParte]["Última Entrada"])) {
          stockMap[numeroParte]["Última Entrada"] = entrada["Fecha de Entrada"];
        }
      });
      
      return Object.values(stockMap);
    }

    function displayStock(stock) {
      const stockItems = safeGetElement('stock-items');
      if (!stockItems) return;
      
      stockItems.innerHTML = '';
      
      if (stock.length === 0) {
        stockItems.innerHTML = '<tr><td colspan="6" class="py-8 px-4 text-center text-gray-500">No hay elementos en el inventario</td></tr>';
        updateStockPagination(0, 0);
        return;
      }
      
      stock.forEach(item => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';
        
        const imageCell = item["Imágenes"] && item["Ruta de Imagen"] ? 
          `<img src="${getImageUrl(item["Ruta de Imagen"])}" alt="Miniatura" class="thumbnail mx-auto" onclick="showImageModal('${getImageUrl(item["Ruta de Imagen"])}')">` : 
          '<span class="text-gray-400 text-sm">Sin imagen</span>';
        
        row.innerHTML = `
          <td class="py-3 px-4 border-b font-medium">${item["Número de Parte"]}</td>
          <td class="py-3 px-4 border-b">${item["Descripción del accesorio"]}</td>
          <td class="py-3 px-4 border-b">${item["Ubicación"]}</td>
          <td class="py-3 px-4 border-b text-right font-medium ${item["Cantidad Disponible"] <= 5 ? 'text-red-600' : 'text-green-600'}">${item["Cantidad Disponible"]}</td>
          <td class="py-3 px-4 border-b text-center">${imageCell}</td>
          <td class="py-3 px-4 border-b text-center">
            <button class="text-blue-600 hover:text-blue-800 mx-1 p-1" onclick="editStock('${item["Número de Parte"]}')" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="text-red-600 hover:text-red-800 mx-1 p-1" onclick="confirmDeleteStock('${item["Número de Parte"]}')" title="Eliminar">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        stockItems.appendChild(row);
      });
      
      updateStockPagination(stock.length, stock.length);
    }

    function updateStockPagination(showing, total) {
      safeSetTextContent('items-showing', showing);
      safeSetTextContent('items-total', total);
    }

    function applyStockFilters() {
      const filters = {
        "Número de Parte": safeGetElement('filtro-parte')?.value || '',
        "Descripción del accesorio": safeGetElement('filtro-descripcion')?.value || '',
        "Ubicación": safeGetElement('filtro-ubicacion')?.value || ''
      };
      
      const filteredStock = currentStock.filter(item => {
        return Object.entries(filters).every(([key, value]) => {
          if (!value) return true;
          return item[key].toLowerCase().includes(value.toLowerCase());
        });
      });
      
      displayStock(filteredStock);
      showToast('Filtros aplicados', 'success');
    }

    function clearStockFilters() {
      safeSetValue('filtro-parte', '');
      safeSetValue('filtro-descripcion', '');
      safeSetValue('filtro-ubicacion', '');
      displayStock(currentStock);
      showToast('Filtros limpiados', 'success');
    }

    // ===== FUNCIONES DE ENTREGA =====
    async function handleEntregaSubmit(e) {
      e.preventDefault();
      
      const isEditing = safeGetElement('entrega-id')?.value;
      const button = safeGetElement('registrar-salida');
      const originalText = button?.innerHTML;
      
      try {
        if (button) {
          button.disabled = true;
          button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Registrando...';
        }
        
        const formData = {
          "ID de Accesorio": safeGetElement('accesorio-id')?.value || '',
          "Cantidad": parseInt(safeGetElement('cantidad-salida')?.value || 0),
          "Tipo de Accesorio": safeGetElement('tipo-accesorio')?.value || '',
          "Fecha de Salida": safeGetElement('fecha-salida')?.value || '',
          "Supervisor": safeGetElement('supervisor')?.value || '',
          "Persona que entrega": safeGetElement('persona-entrega')?.value || ''
        };
        
        if (isEditing) {
          formData.id = parseInt(isEditing);
        }
        
        // Validar stock disponible
        const stockItem = currentStock.find(item => item["Número de Parte"] === formData["ID de Accesorio"]);
        if (!stockItem || stockItem["Cantidad Disponible"] < formData["Cantidad"]) {
          throw new Error('Stock insuficiente');
        }
        
        const result = isEditing ? 
          await executeQuery('update', 'entrega', formData) :
          await executeQuery('insert', 'entrega', formData);
        
        if (result.error) {
          throw new Error(result.error.message);
        }
        
        showToast(isEditing ? 'Entrega actualizada correctamente' : 'Entrega registrada correctamente', 'success');
        clearEntregaForm();
        loadStock(); // Actualizar stock
        loadEntregas(); // Actualizar entregas
        
      } catch (error) {
        console.error('Error al guardar entrega:', error);
        showToast('Error al guardar entrega: ' + error.message, 'error');
      } finally {
        if (button) {
          button.disabled = false;
          button.innerHTML = originalText || '<i class="fas fa-paper-plane mr-2"></i><span>Registrar Entrega</span>';
        }
      }
    }

    // ===== FUNCIÓN CORREGIDA clearEntregaForm =====
    function clearEntregaForm() {
      try {
        // Resetear formulario de manera segura
        const form = safeGetElement('entrega-form');
        if (form) {
          form.reset();
        }
        
        // Limpiar campos específicos
        safeSetValue('entrega-id', '');
        
        // Resetear texto del botón
        safeSetInnerHTML('btn-entrega-text', 'Registrar Entrega');
        
        // Ocultar botón de cancelar
        safeAddClass('cancelar-entrega', 'hidden');
        
        // Limpiar información de stock
        safeSetTextContent('stock-disponible', '');
        
        // Establecer fecha actual
        setCurrentDateTime();
        
        // Limpiar errores del formulario
        clearFormErrors();
        
        console.log('Formulario de entrega limpiado correctamente');
      } catch (error) {
        console.error('Error al limpiar formulario de entrega:', error);
        showToast('Formulario limpiado (con advertencias menores)', 'warning');
      }
    }

    function cancelEntregaEdit() {
      clearEntregaForm();
    }

    async function loadEntregas() {
      try {
        safeSetInnerHTML('entregas-items', '<tr><td colspan="8" class="py-8 px-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Cargando entregas...</td></tr>');
        
        const { data, error } = await executeQuery('select', 'entrega');
        
        if (error) {
          throw new Error(error.message);
        }
        
        currentEntregas = data;
        displayEntregas(data);
        
      } catch (error) {
        console.error('Error al cargar entregas:', error);
        showToast('Error al cargar entregas', 'error');
      }
    }

    function displayEntregas(entregas) {
      const entregasItems = safeGetElement('entregas-items');
      if (!entregasItems) return;
      
      entregasItems.innerHTML = '';
      
      if (entregas.length === 0) {
        entregasItems.innerHTML = '<tr><td colspan="8" class="py-8 px-4 text-center text-gray-500">No hay registros de entregas</td></tr>';
        updateEntregasPagination(0, 0);
        return;
      }
      
      entregas.forEach(item => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';
        
        const fecha = new Date(item["Fecha de Salida"]).toLocaleDateString('es-ES', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        row.innerHTML = `
          <td class="py-3 px-4 border-b font-medium">${item.id}</td>
          <td class="py-3 px-4 border-b">${item["ID de Accesorio"]}</td>
          <td class="py-3 px-4 border-b">${item["Tipo de Accesorio"]}</td>
          <td class="py-3 px-4 border-b text-right font-medium">${item["Cantidad"]}</td>
          <td class="py-3 px-4 border-b">${fecha}</td>
          <td class="py-3 px-4 border-b">${item["Supervisor"]}</td>
          <td class="py-3 px-4 border-b">${item["Persona que entrega"]}</td>
          <td class="py-3 px-4 border-b text-center">
            <button class="text-blue-600 hover:text-blue-800 mx-1 p-1" onclick="editEntrega(${item.id})" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="text-red-600 hover:text-red-800 mx-1 p-1" onclick="confirmDeleteEntrega(${item.id})" title="Eliminar">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        entregasItems.appendChild(row);
      });
      
      updateEntregasPagination(entregas.length, entregas.length);
    }

    function updateEntregasPagination(showing, total) {
      safeSetTextContent('entregas-showing', showing);
      safeSetTextContent('entregas-total', total);
    }

    function loadAccesoriosDropdown() {
      const dropdown = safeGetElement('accesorio-id');
      if (!dropdown) return;
      
      dropdown.innerHTML = '<option value="">Seleccione un accesorio</option>';
      
      currentStock.forEach(item => {
        if (item["Cantidad Disponible"] > 0) {
          const option = document.createElement('option');
          option.value = item["Número de Parte"];
          option.textContent = `${item["Número de Parte"]} - ${item["Descripción del accesorio"]} (${item["Cantidad Disponible"]} disponibles)`;
          dropdown.appendChild(option);
        }
      });
    }

    function updateStockInfo() {
      const accesorioId = safeGetElement('accesorio-id')?.value;
      const stockInfo = safeGetElement('stock-disponible');
      
      if (!stockInfo) return;
      
      if (accesorioId) {
        const stockItem = currentStock.find(item => item["Número de Parte"] === accesorioId);
        if (stockItem) {
          stockInfo.textContent = `Stock disponible: ${stockItem["Cantidad Disponible"]} unidades`;
          stockInfo.className = stockItem["Cantidad Disponible"] <= 5 ? 'text-sm text-red-600 mt-1' : 'text-sm text-green-600 mt-1';
        }
      } else {
        stockInfo.textContent = '';
      }
    }

    function applyEntregasFilters() {
      const filters = {
        "Fecha de Salida": safeGetElement('filtro-fecha')?.value || '',
        "Supervisor": safeGetElement('filtro-supervisor')?.value || '',
        "Tipo de Accesorio": safeGetElement('filtro-tipo')?.value || ''
      };
      
      const filteredEntregas = currentEntregas.filter(item => {
        return Object.entries(filters).every(([key, value]) => {
          if (!value) return true;
          
          if (key === "Fecha de Salida") {
            const itemDate = new Date(item[key]).toISOString().split('T')[0];
            return itemDate === value;
          }
          
          return item[key].toLowerCase().includes(value.toLowerCase());
        });
      });
      
      displayEntregas(filteredEntregas);
      showToast('Filtros aplicados', 'success');
    }

    function clearEntregasFilters() {
      safeSetValue('filtro-fecha', '');
      safeSetValue('filtro-supervisor', '');
      safeSetValue('filtro-tipo', '');
      displayEntregas(currentEntregas);
      showToast('Filtros limpiados', 'success');
    }

    // ===== FUNCIONES DE EDICIÓN Y ELIMINACIÓN =====
    function editStock(numeroParte) {
      // Buscar la entrada más reciente para este número de parte
      const entrada = mockData.entrada.find(e => e["Número de Parte"] === numeroParte);
      if (!entrada) return;
      
      // Llenar formulario
      safeSetValue('entrada-id', entrada.id);
      safeSetValue('numero-parte', entrada["Número de Parte"]);
      safeSetValue('descripcion', entrada["Descripción del accesorio"]);
      safeSetValue('ubicacion', entrada["Ubicación"]);
      safeSetValue('cantidad', entrada["Cantidad ingresada"]);
      
      const fecha = new Date(entrada["Fecha de Entrada"]);
      safeSetValue('fecha-entrada', fecha.toISOString().slice(0, 16));
      
      // Cambiar a modo edición
      safeSetTextContent('btn-text', 'Actualizar Entrada');
      safeRemoveClass('cancelar-entrada', 'hidden');
      
      // Cambiar a pestaña de entrada
      const entradaTab = document.querySelector('.tab-link[data-tab="entrada"]');
      if (entradaTab) entradaTab.click();
      
      showToast('Editando entrada. Modifique los campos y guarde los cambios.', 'info');
    }

    async function confirmDeleteStock(numeroParte) {
      const confirmed = await Swal.fire({
        title: '¿Estás seguro?',
        text: `Se eliminará todo el stock del producto ${numeroParte}`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      });
      
      if (confirmed.isConfirmed) {
        // Eliminar todas las entradas con este número de parte
        const entradas = mockData.entrada.filter(e => e["Número de Parte"] === numeroParte);
        
        for (const entrada of entradas) {
          await executeQuery('delete', 'entrada', { id: entrada.id });
        }
        
        showToast('Stock eliminado correctamente', 'success');
        loadStock();
      }
    }

    function editEntrega(id) {
      const entrega = currentEntregas.find(e => e.id === id);
      if (!entrega) return;
      
      // Llenar formulario
      safeSetValue('entrega-id', entrega.id);
      safeSetValue('accesorio-id', entrega["ID de Accesorio"]);
      safeSetValue('tipo-accesorio', entrega["Tipo de Accesorio"]);
      safeSetValue('cantidad-salida', entrega["Cantidad"]);
      safeSetValue('supervisor', entrega["Supervisor"]);
      safeSetValue('persona-entrega', entrega["Persona que entrega"]);
      
      const fecha = new Date(entrega["Fecha de Salida"]);
      safeSetValue('fecha-salida', fecha.toISOString().slice(0, 16));
      
      // Cambiar a modo edición
      safeSetTextContent('btn-entrega-text', 'Actualizar Entrega');
      safeRemoveClass('cancelar-entrega', 'hidden');
      
      updateStockInfo();
      showToast('Editando entrega. Modifique los campos y guarde los cambios.', 'info');
    }

    async function confirmDeleteEntrega(id) {
      const confirmed = await Swal.fire({
        title: '¿Estás seguro?',
        text: "Esta acción no se puede revertir",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      });
      
      if (confirmed.isConfirmed) {
        try {
          const { error } = await executeQuery('delete', 'entrega', { id });
          
          if (error) {
            throw new Error(error.message);
          }
          
          showToast('Entrega eliminada correctamente', 'success');
          loadEntregas();
          loadStock(); // Actualizar stock
        } catch (error) {
          console.error('Error al eliminar entrega:', error);
          showToast('Error al eliminar entrega', 'error');
        }
      }
    }

    // ===== FUNCIONES DE UTILIDAD =====
    async function uploadImage(file) {
      if (!isConnected) {
        return { data: { path: `${CONFIG.supabase.storage.folder}/${Date.now()}_${file.name}` }, error: null };
      }

      try {
        const fileName = `${Date.now()}_${file.name}`;
        const filePath = `${CONFIG.supabase.storage.folder}/${fileName}`;
        
        const { data, error } = await supabase.storage
          .from(CONFIG.supabase.storage.bucketName)
          .upload(filePath, file);
          
        return { data, error };
      } catch (error) {
        console.error('Error al subir imagen:', error);
        return { data: null, error };
      }
    }

    function getImageUrl(path) {
      if (!isConnected || !path) {
        return 'https://via.placeholder.com/150x150?text=Sin+Imagen';
      }

      try {
        const { data } = supabase.storage
          .from(CONFIG.supabase.storage.bucketName)
          .getPublicUrl(path);
        return data.publicUrl;
      } catch (error) {
        console.error('Error al obtener URL de imagen:', error);
        return 'https://via.placeholder.com/150x150?text=Error';
      }
    }

    function showToast(message, type = 'success', duration = 3000) {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type} show`;
      toast.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-2 hover:opacity-75">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    function clearFormErrors() {
      document.querySelectorAll('.form-error').forEach(el => {
        el.classList.remove('form-error');
      });
      document.querySelectorAll('.error-message').forEach(el => {
        el.classList.add('hidden');
        el.textContent = '';
      });
    }

    function exportStock(format) {
      if (format === 'excel') {
        exportToExcel(currentStock, 'inventario_stock', 'Stock');
      } else if (format === 'pdf') {
        exportToPDF(currentStock, 'Reporte de Stock', 'inventario_stock');
      }
    }

    function exportEntregas(format) {
      if (format === 'excel') {
        exportToExcel(currentEntregas, 'historial_entregas', 'Entregas');
      } else if (format === 'pdf') {
        exportToPDF(currentEntregas, 'Historial de Entregas', 'historial_entregas');
      }
    }

    function exportToExcel(data, filename, sheetName) {
      try {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        XLSX.writeFile(wb, `${filename}.xlsx`);
        showToast('Archivo Excel descargado correctamente', 'success');
      } catch (error) {
        console.error('Error al exportar Excel:', error);
        showToast('Error al exportar a Excel', 'error');
      }
    }

    function exportToPDF(data, title, filename) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFont('helvetica');
        doc.setFontSize(16);
        doc.text(title, 20, 20);
        
        doc.setFontSize(10);
        doc.text(`Generado el: ${new Date().toLocaleDateString('es-ES')}`, 20, 30);
        
        if (data.length > 0) {
          const columns = Object.keys(data[0]);
          const rows = data.map(item => columns.map(col => String(item[col] || '')));
          
          doc.autoTable({
            head: [columns],
            body: rows,
            startY: 40,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [66, 139, 202] }
          });
        }
        
        doc.save(`${filename}.pdf`);
        showToast('Archivo PDF descargado correctamente', 'success');
      } catch (error) {
        console.error('Error al exportar PDF:', error);
        showToast('Error al exportar a PDF', 'error');
      }
    }

    function loadInitialData() {
      loadStock();
    }

    // Hacer funciones globales
    window.editStock = editStock;
    window.confirmDeleteStock = confirmDeleteStock;
    window.editEntrega = editEntrega;
    window.confirmDeleteEntrega = confirmDeleteEntrega;
    window.showImageModal = showImageModal;
    window.closeImageModal = closeImageModal;
    window.removeImagePreview = removeImagePreview;
  </script>
</body>
</html>

